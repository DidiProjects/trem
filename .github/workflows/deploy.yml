name: Deploy to Home Server

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest -v --tb=short
        env:
          API_KEY: test-api-key

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase repository name
        id: repo
        run: echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Build and push to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ steps.repo.outputs.name }}:latest
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:buildcache,mode=max

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
          tags: tag:github-actions

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Pull and deploy on Home Server
        run: |
          REPO_LOWER="${{ steps.repo.outputs.name }}"
          ssh -o StrictHostKeyChecking=no -p 1024 diego@${{ vars.TAILSCALE_IP }} << EOF
          
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          sudo docker pull ghcr.io/${REPO_LOWER}:latest
          
          sudo docker stop trem-api || true
          sudo docker rm trem-api || true
          
          sudo docker run -d --name trem-api \
            --label app=trem-api \
            --label project=trem \
            -p 0.0.0.0:${{ vars.API_PORT }}:${{ vars.CONTAINER_PORT }} \
            --restart=unless-stopped \
            --network=bridge \
            -e API_PORT=${{ vars.API_PORT }} \
            -e API_URL=${{ vars.API_URL }} \
            -e API_KEY=${{ secrets.API_KEY }} \
            -e UPLOAD_DIR=/tmp/uploads \
            -e MAX_FILE_SIZE=52428800 \
            ghcr.io/${REPO_LOWER}:latest
          
          EOF

      # Verificação com retry
      - name: Verify deployment success
        run: |
          ssh -o StrictHostKeyChecking=no -p 1024 diego@${{ vars.TAILSCALE_IP }} << 'EOF'
          
          echo "Aguardando inicialização do container..."
          sleep 10
          
          # Verificar se o container está rodando
          if sudo docker ps | grep -q trem-api; then
            echo "Container trem-api está rodando"
          else
            echo "Container trem-api não está rodando"
            sudo docker logs --tail 20 trem-api
            exit 1
          fi
          
          # Verificar health check com timeout
          echo "Verificando health check..."
          for i in {1..6}; do
            if sudo docker inspect trem-api --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
              echo "Aplicação está saudável"
              break
            elif [ $i -eq 6 ]; then
              echo "Health check não passou, mas container está rodando"
              sudo docker logs --tail 10 trem-api
            else
              echo "Aguardando health check... ($i/6)"
              sleep 10
            fi
          done
          
          EOF

      # Status final e limpeza
      - name: Final status and cleanup
        run: |
          ssh -o StrictHostKeyChecking=no -p 1024 diego@${{ vars.TAILSCALE_IP }} << 'EOF'
          
          echo "=== Status final ==="
          sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "=== Logs recentes ==="
          sudo docker logs --tail 10 trem-api
          
          echo "=== Uso de recursos ==="
          free -h
          sudo docker stats --no-stream trem-api || echo "Stats não disponível"
          
          echo "=== Teste de conectividade ==="
          curl -s -I http://localhost:${{ vars.API_PORT }}/health || echo "Health check local falhou"
          
          echo "=== Limpeza SEGURA (apenas trem-api) ==="
          
          # 1. Remover apenas imagens antigas do trem-api (manter latest)
          echo "Removendo versões antigas do trem-api..."
          sudo docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | \
          grep "^trem-api:" | grep -v ":latest$" | awk '{print $2}' | \
          head -n 5 | xargs -r sudo docker rmi || true
          
          # 2. Remover apenas imagens dangling do trem-api
          echo "Removendo imagens órfãs do trem-api..."
          sudo docker images --filter "dangling=true" --filter "label=app=trem-api" -q | \
          xargs -r sudo docker rmi || true
          
          # 3. Manter apenas últimos 3 backups do trem-api
          echo "Mantendo apenas 3 backups do trem-api..."
          sudo docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | \
          grep "^trem-api:backup-" | tail -n +4 | awk '{print $2}' | \
          xargs -r sudo docker rmi || true
          
          # 4. Remover apenas containers órfãos do trem-api
          echo "Removendo containers órfãos do trem-api..."
          sudo docker ps -a --filter "name=trem-api" --filter "status=exited" -q | \
          xargs -r sudo docker rm || true
          
          echo "=== Status pós-limpeza ==="
          echo "Imagens do trem-api restantes:"
          sudo docker images | grep "trem-api" || echo "Nenhuma imagem trem-api encontrada"
          echo "Espaço usado pelo Docker:"
          sudo docker system df
          
          echo "Deploy e limpeza seguros concluídos!"
          
          EOF